generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  password      String?
  role          String    @default("USER") // SUPER_ADMIN, ADMIN, USER
  
  active        Boolean   @default(true)
  
  tenantId      String?
  tenant        Tenant?   @relation(fields: [tenantId], references: [id])
  
  accounts      Account[]
  sessions      Session[]
  orders        Order[] // Orders created by this user (seller)
  activityLogs  ActivityLog[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime? // Soft Delete
}

model ActivityLog {
  id        String   @id @default(cuid())
  action    String   // CREATE, UPDATE, DELETE, LOGIN, etc.
  entity    String   // USER, TENANT, PLAN, etc.
  entityId  String?
  details   String?
  
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  
  tenantId  String?
  metadata  String? // JSON payload
  ipAddress String?
  userAgent String?
  status    String? // SUCCESS, ERROR, WARNING
  
  createdAt DateTime @default(now())
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Plan {
  id              String   @id @default(cuid())
  name            String
  slug            String   @unique
  description     String?
  price           Decimal
  maxProducts     Int      @default(10)
  maxOrders       Int      @default(50)
  maxUsers        Int      @default(1)
  maxIntegrations Int      @default(0)
  active          Boolean  @default(true)
  
  tenants         Tenant[] @relation("TenantPlan")

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Tenant {
  id              String   @id @default(cuid())
  name            String
  slug            String   @unique
  document        String?  // CPF/CNPJ
  email           String?
  phone           String?
  
  // Branding
  primaryColor    String?
  logo            String?
  
  // Address
  address         String?
  city            String?
  state           String?
  zipCode         String?

  status          String   @default("ACTIVE") // ACTIVE, SUSPENDED, BLOCKED
  
  stripeCustomerId String? @unique

  planId          String?
  planRel         Plan?    @relation("TenantPlan", fields: [planId], references: [id])
  plan            String?  // Legacy field, keep for now or remove if safe
  
  users           User[]
  products        Product[]
  orders          Order[]
  customers       Customer[]
  integrations    Integration[]
  inventory       Inventory[]
  subscriptions   Subscription[]
  invoices        Invoice[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Subscription {
  id                   String   @id @default(cuid())
  stripeSubscriptionId String   @unique
  status               String   // ACTIVE, PAST_DUE, CANCELED, TRIALING
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean  @default(false)
  
  tenantId             String
  tenant               Tenant   @relation(fields: [tenantId], references: [id])
  
  planId               String
  
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

model Invoice {
  id              String   @id @default(cuid())
  stripeInvoiceId String   @unique
  amount          Decimal
  status          String   // PAID, OPEN, VOID, UNCOLLECTIBLE
  pdfUrl          String?
  paidAt          DateTime?
  
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  
  subscriptionId  String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Product {
  id          String   @id @default(cuid())
  name        String
  description String?
  price       Decimal
  sku         String?
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  inventory   Inventory?
  orderItems  OrderItem[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime? // Soft Delete
}

model Inventory {
  id          String   @id @default(cuid())
  quantity    Int      @default(0)
  minStock    Int      @default(0)
  
  productId   String   @unique
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  updatedAt   DateTime @updatedAt
}

model Customer {
  id          String   @id @default(cuid())
  name        String
  email       String?
  phone       String?
  document    String?
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  orders      Order[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Order {
  id          String   @id @default(cuid())
  status      String   @default("PENDING") // PENDING, PAID, SHIPPED, DELIVERED, CANCELED
  total       Decimal
  notes       String?
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  customerId  String?
  customer    Customer? @relation(fields: [customerId], references: [id])
  
  sellerId    String?
  seller      User?    @relation(fields: [sellerId], references: [id])
  
  items       OrderItem[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model OrderItem {
  id          String   @id @default(cuid())
  quantity    Int
  price       Decimal
  subtotal    Decimal
  
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
}

model Integration {
  id          String   @id @default(cuid())
  provider    String   // SHOPEE, MERCADOLIVRE, ETC
  name        String?
  active      Boolean  @default(true)
  
  apiKey      String?
  apiSecret   String?
  accessToken String?
  refreshToken String?
  expiresAt   DateTime?
  
  settings    String? // Changed from Json to String for SQLite
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
